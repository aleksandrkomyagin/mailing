<div align=center>
    <h1> Сервис уведомлений </h1>
</div>

## Проект в рамках выполнениня тестового задания на вакансию Python-разработчик (Django, DRF). 

У текущего тестового задания есть только общее описание требований, конкретные дтали реализации остаются на усмотрение разработчика. Решение по стеку технологий, которые необходимы для решения задачи, также принимает кандидат по своему усмотрению.

<div align=center>

![Python](https://img.shields.io/badge/Python-3.9.10-blue)
![Django](https://img.shields.io/badge/Django-3.2-blue)
![Django_REST_framework](https://img.shields.io/badge/Django_REST_framework-3.14.0-blue)
![Nginx](https://img.shields.io/badge/Nginx-1.18.0-blue)
![Gunicorn](https://img.shields.io/badge/Gunicorn-21.2.0-blue)
![JWT](https://img.shields.io/badge/Jwt-5.3.0-blue)
![Postgres](https://img.shields.io/badge/Postgres-13.10-blue)
![Redis](https://img.shields.io/badge/Redis-5.0.0-blue)
![Celery](https://img.shields.io/badge/Celery-5.3.1-blue)
![Spectacular](https://img.shields.io/badge/Spectacular-0.26.4-blue)
![Django_celery_beat](https://img.shields.io/badge/Django_celery_beat-2.5.0-blue)

</div>

## Задача
Необходимо разработать сервис управления рассылками API администрирования и получения статистики.

## Дополнительные задания
Опциональные пункты, выполнение любого количества из приведённого списка повышают ваши шансы на положительное решение о приёме

* организовать тестирование написанного кода
* обеспечить автоматическую сборку/тестирование с помощью GitLab CI
* подготовить docker-compose для запуска всех сервисов проекта одной командой
* написать конфигурационные файлы (deployment, ingress, …) для запуска проекта в kubernetes и описать как их применить к работающему кластеру
* сделать так, чтобы по адресу /docs/ открывалась страница со Swagger UI и в нём отображалось описание разработанного API.
* реализовать администраторский Web UI для управления рассылками и получения статистики по отправленным сообщениям
* обеспечить интеграцию с внешним OAuth2 сервисом авторизации для административного интерфейса. Пример: https://auth0.com
* реализовать дополнительный сервис, который раз в сутки отправляет статистику по обработанным рассылкам на email
* удаленный сервис может быть недоступен, долго отвечать на запросы или выдавать некорректные ответы. Необходимо организовать обработку ошибок и откладывание запросов при неуспехе для последующей повторной отправки. Задержки в работе внешнего сервиса никак не должны оказывать влияние на работу сервиса рассылок.
* реализовать отдачу метрик в формате prometheus и задокументировать эндпоинты и экспортируемые метрики
* реализовать дополнительную бизнес-логику: добавить в сущность "рассылка" поле "временной интервал", в котором можно задать промежуток времени, в котором клиентам можно отправлять сообщения с учётом их локального времени. Не отправлять клиенту сообщение, если его локальное время не входит в указанный интервал.
* обеспечить подробное логирование на всех этапах обработки запросов, чтобы при эксплуатации была возможность найти в логах всю информацию по: 
    * id рассылки - все логи по конкретной рассылке (и запросы на api и внешние запросы на отправку конкретных сообщений)
    * id сообщения - по конкретному сообщению (все запросы и ответы от внешнего сервиса, вся обработка конкретного сообщения)
    * id клиента - любые операции, которые связаны с конкретным клиентом (добавление/редактирование/отправка сообщения/…)

## Описание проекта

Реализованы методы создания новой рассылки, просмотра созданных и получения статистики по выполненным рассылкам. Реализован сам сервис отправки эл.писем с фильтрацией по уровню клиента и коду оператора, предпочтительному времени получения уведомлений, с учетом часового пояса клиента. В будущем, можно подключить рассылку СМС через сторонее API. В проекте создано две таблицы с пользователями. Таблица User - сотрудники. Таблица Client - клиенты. Также, есть другие таблицы: Tag, Code, Mail, Mailing. Таблица Tag - уровень клиента(новичек, старый клиент и т.д.). Можно создать любой уровень. Таблица Code - коды оператора. Таблица Mailing - управление рассылками(создание, удаление, редактирование, полученение). Таблица Mail - таблица для получения статистики. Документация проекта с использованием Swagger UI.
Реализован дополнительный сервис, который раз в сутки отправляет статистику по обработанным рассылкам на выбранный email. Задача запускается и отменяется отдельной менеджмент-командой.

## Особенности реализации

* Использовались два официальных образа(nginx и postgres) и 1 разработанный образ(mailing_backend). Образ хранится на DockerHub
* Реализован workflow c автодеплоем на удаленный сервер и отправкой сообщения в Telegram

## Логика рассылки

* После создания новой рассылки, если текущее время больше времени начала и меньше времени окончания - должны быть выбраны из справочника все клиенты, которые подходят под значения фильтра, указанного в этой рассылке и запущена отправка для всех этих клиентов.
* Если создаётся рассылка с временем старта в будущем - отправка должна стартовать автоматически по наступлению этого времени без дополнительных действий со стороны пользователя системы.
* По ходу отправки сообщений должна собираться статистика по каждому письму для последующего формирования отчётов.
* Внешний сервис, который принимает отправляемые письма, может долго обрабатывать запрос, отвечать некорректными данными, на какое-то время вообще не принимать запросы. Необходимо реализовать корректную обработку подобных ошибок. Проблемы с внешним сервисом не должны влиять на стабильность работы разрабатываемого сервиса рассылок.

## Ресурсы API

* Ресурс **api/signup**: получение кода подтверждения для получения токена
* Ресурс **api/token**: получение токена для дальнейшей работы
* Ресурс **api/users**: создание, удаление, редактирование и получение сотрудника/списка сотрудников
* Ресурс **api/users/me**: получение информации о собственном профиле
* Ресурс **api/users/set_password**: изменение пароля
* Ресурс **api/client**: создание, удаление, редактирование и получение клиента
* Ресурс **api/mailing**: создание, удаление, редактирование и получение рассылки
* Ресурс **api/mailing/get_stat_all_mailings**: получение статистики по всем рассылкам
* Ресурс **api/mailing/get_stat_mailing**: получение детельной статистики по конкретной рассылке
* Ресурс **api/schema/docs**: документация


<details>
  <summary>
    <h2>Запуск проекта на локальном сервере</h2>
  </summary>

1. Клонировать репозиторий.
   ```
       $ git@github.com:aleksandrkomyagin/mailing.git
   ```
2. Создать и активировать виртуальное окружение.
   ```
       $ python -m venv venv
   ```
   Для Windows:
   ```
       $ source venv/Scripts/activate
   ```
   Для MacOs/Linux:
   ```
       $ source venv/bin/activate
   ```
3. Запустить docker-compose из дирректории gateway.Перед запуском в корне проекта создать файл .env, по шаблону(в корне проекта файл .env.example).
    ```
        $ docker-compose up --build
    ```
4. Создать миграции и собрать статику.
    ```
        $ docker-compose exec backend python manage.py migrate
        $ docker-compose exec backend python manage.py collectstatic
    ```
5. Создать суперпользователя и через админ панель создать хотя бы 1 тег.
    ```
        $ docker-compose exec backend python manage.py createsuperuser
    ```
6. Запуск worker и beat.
    ```
        $ docker-compose exec backend python -m celery -A mailing worker -B -l info
    ```
7. Запуск и отмена задачи для отправки отчета 1 раз в сутки.
    Запуск
    ```
        $ docker-compose exec backend python manage.py send_report_task -r/--run
    ```
    Отмена
    ```
        $ docker-compose exec backend python manage.py send_report_task -s/--stop
    ```
- После выполнения вышеперечисленных инструкций бэкенд проекта будет доступен по адресу http://127.0.0.1:8080/
- Документация проекта доступна по адресу http://127.0.0.1:8080/api/schema/docs/

</details>

---

<div align=center>

## Контакты

[![Telegram Badge](https://img.shields.io/badge/-aleksandrkomyagin8-blue?style=social&logo=telegram&link=https://t.me/aleksandrkomyagin8)](https://t.me/aleksandrkomyagin8) [![Gmail Badge](https://img.shields.io/badge/-aleksandrkomyagin8@gmail.com-c14438?style=flat&logo=Gmail&logoColor=white&link=mailto:aleksandrkomyagin8@gmail.com)](mailto:aleksandrkomyagin8@gmail.com)

</div>
